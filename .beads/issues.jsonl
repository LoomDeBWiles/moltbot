{"id":"moltbot-sz1","title":"Unified Memory: Index Claude Code sessions","description":"\n\u003e Index ~/.claude/projects/ sessions into moltbot memory, enabling search across phone (Telegram) and direct CLI usage.\n\n## Key Insight\n\n**Separate parser for Claude format, not a format flag.** Claude JSONL uses `type: \"user\"/\"assistant\"` vs moltbot `type: \"message\"`. Rather than adding conditionals to existing parser, create `claude-session-files.ts` alongside `session-files.ts`. Keeps parsers focused and testable.\n\n## Architecture\n\nclaude-sessions is a **file indexing pipeline** parallel to existing sessions source:\n\n```\n~/.claude/projects/*/*.jsonl\n    → listClaudeSessionFiles()\n    → buildClaudeSessionEntry() [extracts text, project slug]\n    → deduplicateBySessionId() [skip moltbot-originated sessions]\n    → indexFile() [existing chunking + embedding]\n    → search() [with optional project filter]\n```\n\n## Public API\n\n| Function | Signature | Purpose |\n|----------|-----------|---------|\n| `listClaudeSessionFiles` | `() -\u003e Promise\u003cstring[]\u003e` | Glob ~/.claude/projects/*/*.jsonl |\n| `buildClaudeSessionEntry` | `(absPath: string) -\u003e Promise\u003cClaudeSessionEntry \\| null\u003e` | Parse Claude JSONL, extract project |\n| `extractProjectSlug` | `(sessionPath: string) -\u003e string` | -home-ben-projects-mine → mine |\n| `loadMoltbotSessionIds` | `(agentId: string) -\u003e Promise\u003cSet\u003cstring\u003e\u003e` | Get Claude session IDs from moltbot sessions.json |\n| `syncClaudeSessionFiles` | `(params) -\u003e Promise\u003cvoid\u003e` | Index with deduplication |\n\n## Types\n\n```typescript\ntype ClaudeSessionEntry = SessionFileEntry \u0026 {\n  project: string;  // extracted slug (e.g., \"mine\", \"moltbot\")\n  claudeSessionId: string;  // from filename for dedup\n};\n\n// Extended search options\ninterface MemorySearchOptions {\n  maxResults?: number;\n  minScore?: number;\n  sessionKey?: string;\n  project?: string;  // filter to specific Claude Code project\n}\n```\n\n## Modules\n\n| Module | Purpose |\n|--------|---------|\n| claude-session-files | Parse Claude Code JSONL format, extract project metadata |\n| sync-claude-sessions | Index claude-sessions source with deduplication |\n| memory-search (extend) | Add claude-sessions to sources type |\n| manager (extend) | Integrate claude-sessions sync |\n| memory-cli (extend) | Add --project flag |\n\n## Config Schema\n\n```json\n{\n  \"sources\": [\"memory\", \"sessions\", \"claude-sessions\"],\n  \"claudeSessions\": {\n    \"enabled\": true,\n    \"path\": \"~/.claude/projects\"\n  }\n}\n```\n\n---\nExit criteria: `clawdbot memory search \"query\" --project mine` returns results from ~/.claude/projects/-home-ben-projects-mine/\n","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-28T00:56:47.682324419+01:00","updated_at":"2026-01-28T00:56:47.682324419+01:00"}
{"id":"moltbot-sz1.1","title":"UC-UM-1: Add claude-sessions source type","description":"\n## Participates in\nWF-1: Index Claude sessions\n\n## Touches\n- `src/agents/memory-search.ts:ResolvedMemorySearchConfig`\n- `src/agents/memory-search.ts:normalizeSources`\n\n## Given/When/Then\n**Given:** sources type is `Array\u003c\"memory\" | \"sessions\"\u003e`\n**When:** claude-sessions feature is implemented\n**Then:** sources accepts `\"claude-sessions\"` as valid value\n\n## Contract\n- Input: config with `sources: [\"claude-sessions\"]`\n- Output: resolved config includes `\"claude-sessions\"` in sources array\n- Errors: none (invalid sources ignored)\n\n## Acceptance\n- [ ] `pnpm build \u0026\u0026 grep -q \"claude-sessions\" dist/agents/memory-search.js`\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-28T00:57:06.605844003+01:00","updated_at":"2026-01-28T00:57:06.605844003+01:00","dependencies":[{"issue_id":"moltbot-sz1.1","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:06.639839115+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.10","title":"UC-UM-10: Add project filter to search","description":"\n## Participates in\nWF-2: Search with project filter\n\n## Touches\n- `src/memory/manager.ts:search`\n- `src/memory/manager-search.ts`\n\n## Given/When/Then\n**Given:** chunks indexed with project metadata\n**When:** search() called with project option\n**Then:** returns only chunks matching project filter\n\n## Contract\n- Input: `{ query, project?: string, ... }` — search options with optional project\n- Output: results filtered to specified project\n- Errors: invalid project returns empty results\n\n## Notes\n- Add WHERE clause: `AND (project = ? OR ? IS NULL)`\n- Pass project through to vector and FTS queries\n\n## Acceptance\n- [ ] `pnpm test src/memory/manager-search.test.ts -t \"project filter\"`\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T00:57:57.712060489+01:00","updated_at":"2026-01-28T00:57:57.712060489+01:00","dependencies":[{"issue_id":"moltbot-sz1.10","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:57.745222332+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.10","depends_on_id":"moltbot-sz1.7","type":"blocks","created_at":"2026-01-28T00:58:07.168233747+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.11","title":"UC-UM-11: Add --project flag to memory CLI","description":"\n## Participates in\nWF-2: Search with project filter\n\n## Touches\n- `src/cli/memory-cli.ts`\n\n## Given/When/Then\n**Given:** clawdbot memory search command exists\n**When:** user runs `clawdbot memory search \"query\" --project mine`\n**Then:** search results filtered to project \"mine\"\n\n## Contract\n- Input: `--project \u003cslug\u003e` CLI option\n- Output: filtered search results\n- Errors: invalid project shows \"no results\"\n\n## Acceptance\n- [ ] `pnpm clawdbot memory search --help | grep -q \"\\-\\-project\"`\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T00:57:59.079501282+01:00","updated_at":"2026-01-28T00:57:59.079501282+01:00","dependencies":[{"issue_id":"moltbot-sz1.11","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:59.104796474+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.11","depends_on_id":"moltbot-sz1.10","type":"blocks","created_at":"2026-01-28T00:58:07.188807236+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.12","title":"UC-UM-12: Add file watcher for Claude projects","description":"\n## Participates in\nWF-1: Index Claude sessions (incremental)\n\n## Touches\n- `src/memory/manager.ts:ensureSessionListener`\n\n## Given/When/Then\n**Given:** claude-sessions source enabled with watch=true\n**When:** new session file created in ~/.claude/projects/\n**Then:** file watcher triggers incremental sync\n\n## Contract\n- Input: config with sync.watch=true and sources includes claude-sessions\n- Output: watcher on ~/.claude/projects/**/*.jsonl\n- Errors: watcher failure logged but does not crash\n\n## Notes\n- Use same chokidar pattern as existing session watcher\n- Debounce with watchDebounceMs\n\n## Acceptance\n- [ ] `pnpm test src/memory/manager.test.ts -t \"claude watcher\"`\n","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-28T00:57:59.98124733+01:00","updated_at":"2026-01-28T00:57:59.98124733+01:00","dependencies":[{"issue_id":"moltbot-sz1.12","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:59.981788473+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.12","depends_on_id":"moltbot-sz1.9","type":"blocks","created_at":"2026-01-28T00:58:07.208952333+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.2","title":"UC-UM-2: Add claudeSessions config schema","description":"\n## Participates in\nWF-1: Index Claude sessions\n\n## Touches\n- `src/agents/memory-search.ts:ResolvedMemorySearchConfig`\n- `src/agents/memory-search.ts:mergeConfig`\n- `src/config/config.ts:MemorySearchConfig`\n\n## Given/When/Then\n**Given:** config has claudeSessions object with enabled, path\n**When:** config is resolved\n**Then:** ResolvedMemorySearchConfig includes claudeSessions with defaults\n\n## Contract\n- Input: `{ claudeSessions: { enabled: true, path: \"~/.claude/projects\" } }`\n- Output: resolved config with claudeSessions.enabled=true, claudeSessions.path expanded\n- Errors: none (missing config uses defaults)\n\n## Acceptance\n- [ ] `pnpm build \u0026\u0026 grep -q \"claudeSessions\" dist/agents/memory-search.js`\n","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-28T00:57:07.447920199+01:00","updated_at":"2026-01-28T00:57:07.447920199+01:00","dependencies":[{"issue_id":"moltbot-sz1.2","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:07.465495011+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.3","title":"UC-UM-3: Extract project slug from session path","description":"\n## Participates in\nWF-1: Index Claude sessions\n\n## Touches\n- `src/memory/claude-session-files.ts:extractProjectSlug`\n\n## Given/When/Then\n**Given:** Claude session path like ~/.claude/projects/-home-ben-projects-mine/abc123.jsonl\n**When:** extractProjectSlug() called with path\n**Then:** returns \"mine\" (last component after \"projects-\")\n\n## Contract\n- Input: `sessionPath: string` — absolute path to Claude session file\n- Output: `string` — project slug (e.g., \"mine\", \"patent-search\", \"moltbot\")\n- Errors: returns directory name if no \"projects-\" found\n\n## Acceptance\n- [ ] `pnpm test src/memory/claude-session-files.test.ts -t extractProjectSlug`\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-28T00:57:08.617494904+01:00","updated_at":"2026-01-28T00:57:08.617494904+01:00","dependencies":[{"issue_id":"moltbot-sz1.3","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:08.643398854+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.4","title":"UC-UM-4: List Claude session files","description":"\n## Participates in\nWF-1: Index Claude sessions\n\n## Touches\n- `src/memory/claude-session-files.ts:listClaudeSessionFiles`\n\n## Given/When/Then\n**Given:** ~/.claude/projects/ contains project dirs with .jsonl files\n**When:** listClaudeSessionFiles() called\n**Then:** returns array of absolute paths to all .jsonl files\n\n## Contract\n- Input: `basePath?: string` — defaults to ~/.claude/projects\n- Output: `Promise\u003cstring[]\u003e` — absolute paths to .jsonl files\n- Errors: returns empty array if directory missing\n\n## Acceptance\n- [ ] `pnpm test src/memory/claude-session-files.test.ts -t listClaudeSessionFiles`\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-28T00:57:22.497514556+01:00","updated_at":"2026-01-28T00:57:22.497514556+01:00","dependencies":[{"issue_id":"moltbot-sz1.4","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:22.535554983+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.5","title":"UC-UM-5: Parse Claude JSONL format","description":"\n## Participates in\nWF-1: Index Claude sessions\n\n## Touches\n- `src/memory/claude-session-files.ts:buildClaudeSessionEntry`\n- `src/memory/claude-session-files.ts:extractClaudeSessionText`\n\n## Given/When/Then\n**Given:** Claude JSONL with `{\"type\": \"user\", \"message\": {...}}` and `{\"type\": \"assistant\", \"message\": {...}}`\n**When:** buildClaudeSessionEntry() called with file path\n**Then:** returns entry with extracted text content, project slug, session ID\n\n## Contract\n- Input: `absPath: string` — path to Claude session .jsonl file\n- Output: `Promise\u003cClaudeSessionEntry | null\u003e` — entry with path, content, hash, project, claudeSessionId\n- Errors: returns null if file unreadable or empty\n\n## Notes\n- Accept `type: \"user\"` and `type: \"assistant\"` (not just `type: \"message\"`)\n- Extract only `text` blocks from content arrays\n- Skip `tool_use` and `tool_result` blocks\n\n## Acceptance\n- [ ] `pnpm test src/memory/claude-session-files.test.ts -t buildClaudeSessionEntry`\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-28T00:57:23.744858668+01:00","updated_at":"2026-01-28T00:57:23.744858668+01:00","dependencies":[{"issue_id":"moltbot-sz1.5","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:23.769772243+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.5","depends_on_id":"moltbot-sz1.3","type":"blocks","created_at":"2026-01-28T00:58:06.99167575+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.6","title":"UC-UM-6: Load moltbot session IDs for dedup","description":"\n## Participates in\nWF-1: Index Claude sessions (deduplication)\n\n## Touches\n- `src/memory/claude-session-files.ts:loadMoltbotClaudeSessionIds`\n\n## Given/When/Then\n**Given:** moltbot sessions.json contains claudeCliSessionId for sessions\n**When:** loadMoltbotClaudeSessionIds(agentId) called\n**Then:** returns Set of Claude session IDs that originated from moltbot\n\n## Contract\n- Input: `agentId: string` — moltbot agent ID\n- Output: `Promise\u003cSet\u003cstring\u003e\u003e` — set of Claude session IDs to skip\n- Errors: returns empty set if sessions.json missing or malformed\n\n## Notes\nLocation: ~/.clawdbot/state/agents/{agentId}/sessions/sessions.json\nField: entry.cliSessionIds[\"claude-cli\"] or entry.claudeCliSessionId\n\n## Acceptance\n- [ ] `pnpm test src/memory/claude-session-files.test.ts -t loadMoltbotClaudeSessionIds`\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T00:57:25.431396832+01:00","updated_at":"2026-01-28T00:57:25.431396832+01:00","dependencies":[{"issue_id":"moltbot-sz1.6","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:25.431962992+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.7","title":"UC-UM-7: Add project column to chunks table","description":"\n## Participates in\nWF-2: Search with project filter\n\n## Touches\n- `src/memory/memory-schema.ts` (or sqlite.ts)\n- `src/memory/manager.ts:indexFile`\n\n## Given/When/Then\n**Given:** chunks table has no project column\n**When:** claude-sessions indexed\n**Then:** chunks table has project column, populated for claude-sessions source\n\n## Contract\n- Input: chunk with project metadata\n- Output: chunk stored with project column\n- Errors: migration handles existing DBs gracefully\n\n## Notes\n- Column should be nullable (null for memory/sessions sources)\n- Add index on (source, project) for filtered queries\n\n## Acceptance\n- [ ] `sqlite3 ~/.clawdbot/state/memory/test.sqlite \".schema chunks\" | grep -q project`\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-28T00:57:40.594563824+01:00","updated_at":"2026-01-28T00:57:40.594563824+01:00","dependencies":[{"issue_id":"moltbot-sz1.7","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:40.606869038+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.8","title":"UC-UM-8: Sync Claude session files","description":"\n## Participates in\nWF-1: Index Claude sessions\n\n## Touches\n- `src/memory/sync-claude-sessions.ts:syncClaudeSessionFiles`\n\n## Given/When/Then\n**Given:** Claude sessions exist in ~/.claude/projects/\n**When:** syncClaudeSessionFiles() called with dedup set\n**Then:** indexes all sessions except those in dedup set, stores with project metadata\n\n## Contract\n- Input: `{ db, excludeSessionIds: Set\u003cstring\u003e, indexFile, ... }` — same pattern as syncSessionFiles\n- Output: `Promise\u003cvoid\u003e` — files indexed\n- Errors: skips unreadable files, continues with others\n\n## Notes\n- Follow same pattern as sync-session-files.ts\n- Use source = \"claude-sessions\"\n- Include project in chunk metadata\n\n## Acceptance\n- [ ] `pnpm test src/memory/sync-claude-sessions.test.ts`\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-28T00:57:41.847672336+01:00","updated_at":"2026-01-28T00:57:41.847672336+01:00","dependencies":[{"issue_id":"moltbot-sz1.8","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:41.872676663+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.8","depends_on_id":"moltbot-sz1.4","type":"blocks","created_at":"2026-01-28T00:58:07.023977342+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.8","depends_on_id":"moltbot-sz1.5","type":"blocks","created_at":"2026-01-28T00:58:07.04608811+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.8","depends_on_id":"moltbot-sz1.6","type":"blocks","created_at":"2026-01-28T00:58:07.06713722+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.8","depends_on_id":"moltbot-sz1.7","type":"blocks","created_at":"2026-01-28T00:58:07.087044551+01:00","created_by":"daemon"}]}
{"id":"moltbot-sz1.9","title":"UC-UM-9: Integrate claude-sessions sync into manager","description":"\n## Participates in\nWF-1: Index Claude sessions\n\n## Touches\n- `src/memory/manager.ts:sync`\n- `src/memory/manager.ts:ensureSessionListener`\n\n## Given/When/Then\n**Given:** sources includes \"claude-sessions\"\n**When:** manager.sync() called\n**Then:** calls syncClaudeSessionFiles alongside syncSessionFiles\n\n## Contract\n- Input: resolved config with sources including \"claude-sessions\"\n- Output: claude sessions indexed\n- Errors: failure in claude-sessions sync does not block other sources\n\n## Notes\n- Check sources.includes(\"claude-sessions\") before syncing\n- Load dedup session IDs before sync\n- Optionally add file watcher for ~/.claude/projects\n\n## Acceptance\n- [ ] `pnpm test src/memory/manager.test.ts -t \"claude-sessions\"`\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T00:57:43.634180688+01:00","updated_at":"2026-01-28T00:57:43.634180688+01:00","dependencies":[{"issue_id":"moltbot-sz1.9","depends_on_id":"moltbot-sz1","type":"parent-child","created_at":"2026-01-28T00:57:43.634778498+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.9","depends_on_id":"moltbot-sz1.1","type":"blocks","created_at":"2026-01-28T00:58:07.106931975+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.9","depends_on_id":"moltbot-sz1.2","type":"blocks","created_at":"2026-01-28T00:58:07.127082332+01:00","created_by":"daemon"},{"issue_id":"moltbot-sz1.9","depends_on_id":"moltbot-sz1.8","type":"blocks","created_at":"2026-01-28T00:58:07.147273284+01:00","created_by":"daemon"}]}
